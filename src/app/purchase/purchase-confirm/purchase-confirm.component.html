<div class="confirm-container">
  <h1 class="confirm-title">Purchase Confirmation</h1>

  <!-- カート商品一覧 -->
  <section class="order-summary">
    <h2 class="section-title">Cart Items</h2>
    <table class="cart-items-table">
      <thead>
        <tr>
          <th></th>
          <th>NAME</th>
          <th>PRICE</th>
          <th>QUANTITY</th>
        </tr>
      </thead>
      <tbody>
        @if ((cartItems && cartItems.length > 0)) { @for (item of cartItems; track $index) {
        <tr>
          <td><img [src]="getItemImageUrl(item.image_url)" alt="{{ item.item_name }}" /></td>
          <td>{{ item.name }}</td>
          <td>&yen;{{ item.price | number : '1.0-0' }}</td>
          <td>{{ item.quantity }}</td>
        </tr>
        } } @else {
        <tr>
          <td colspan="4" class="empty-message">Cart is empty.</td>
        </tr>
        }
      </tbody>
    </table>
  </section>

  <!-- 合計金額 -->
  <section class="totals-section">
    <div class="total-row">
      <span><strong>TOTAL:</strong></span>
      <span style="float: right">&yen;{{ getTotal() | number : '1.0-0' }}</span>
    </div>
    <div class="total-row">
      <span><strong>TOTAL WITH TAX (10%):</strong></span>
      <span style="float: right">&yen;{{ getTotalWithTax() | number : '1.0-0' }}</span>
    </div>
  </section>

  <!-- 配送先住所 -->
  <section class="address-section">
    <h2 class="section-title">Shipping Address</h2>
    <p>
      {{ user?.address ? user?.address : 'No address registered.' }}
    </p>
  </section>

  <!-- 支払方法選択と購入ボタン -->
  <form [formGroup]="paymentForm" (ngSubmit)="onPurchase()">
    <section class="payment-section">
      <h2 class="section-title">Payment Method</h2>
      <select
        formControlName="paymentMethod"
        [ngClass]="{
          'has-error':
            paymentForm.get('paymentMethod')?.touched && paymentForm.get('paymentMethod')?.invalid
        }"
      >
        <option value="" disabled>Select a payment method</option>
        @for (method of paymentMethods; track method.id) {
        <option [value]="method.id">{{ method.name }}</option>
        }
      </select>
      @if (paymentForm.get('paymentMethod')?.touched && paymentForm.get('paymentMethod')?.invalid) {
      <div class="error-message">Please select a payment method.</div>
      }
    </section>

    <div class="button-row">
      <button
        class="confirm-btn"
        type="submit"
        [disabled]="paymentForm.invalid || !(cartItems && cartItems.length > 0)"
      >
        PURCHASE
      </button>
      <!-- <button class="cancel-btn" type="button" (click)="onCancel()">CANCEL</button> -->
    </div>

    @if (message) {
    <p class="error-message">{{ message }}</p>
    }
  </form>
</div>
