<div class="confirm-container">
  <h1 class="confirm-title">購入確認</h1>

  <!-- カート商品一覧 -->
  <section class="order-summary">
    <h2 class="section-title">カートの商品一覧</h2>
    <table class="cart-items-table">
      <thead>
        <tr>
          <th></th>
          <th>名前</th>
          <th>価格</th>
          <th>個数</th>
        </tr>
      </thead>
      <tbody>
        @if ((cartItems && cartItems.length > 0)) { @for (item of cartItems; track $index) {
        <tr>
          <td><img [src]="getItemImageUrl(item.image_url)" alt="{{ item.name }}" /></td>
          <td>{{ item.name }}</td>
          <td>{{ item.price | currency : 'JPY' : 'symbol' : '1.0-0' }}</td>
          <td>{{ item.quantity }}</td>
        </tr>
        } } @else {
        <tr>
          <td colspan="4" class="empty-message">カートが空です。</td>
        </tr>
        }
      </tbody>
    </table>
  </section>

  <!-- 合計金額 -->
  <section class="totals-section">
    <div class="total-row">
      <span><strong>合計金額:</strong></span>
      <span>{{ getTotal() | currency : 'JPY' : 'symbol' : '1.0-0' }}</span>
    </div>
    <div class="total-row">
      <span><strong>税込み合計金額:</strong></span>
      <span>{{ getTotalWithTax() | currency : 'JPY' : 'symbol' : '1.0-0' }}</span>
    </div>
  </section>

  <!-- 配送先住所 -->
  <section class="address-section">
    <h2 class="section-title">配送先住所</h2>
    <p>
      {{ user?.address ? user?.address : '配送先住所が登録されていません' }}
    </p>
  </section>

  <!-- 支払方法選択と購入ボタン -->
  <form [formGroup]="paymentForm" (ngSubmit)="onPurchase()">
    <section class="payment-section">
      <h2 class="section-title">支払方法</h2>
      <select
        formControlName="paymentMethod"
        [ngClass]="{
          'has-error':
            paymentForm.get('paymentMethod')?.touched && paymentForm.get('paymentMethod')?.invalid
        }"
      >
        <option value="" disabled>支払方法を選択してください</option>
        @for (method of paymentMethods; track method.id) {
        <option [value]="method.id">{{ method.name }}</option>
        }
      </select>
      @if (paymentForm.get('paymentMethod')?.touched && paymentForm.get('paymentMethod')?.invalid) {
      <div class="error-message">支払方法を選択してください</div>
      }
    </section>

    <div class="button-row">
      <button
        class="confirm-btn"
        type="submit"
        [disabled]="paymentForm.invalid || !(cartItems && cartItems.length > 0)"
      >
        購入
      </button>

      <button class="cancel-btn" type="button" (click)="onCancel()">やめる</button>
    </div>

    @if (message) {
    <p class="error-message">{{ message }}</p>
    }
  </form>
</div>
